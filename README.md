Work in progress. Still needs polish and unit tests.